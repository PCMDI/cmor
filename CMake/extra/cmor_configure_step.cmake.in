set(ENV{PKG_CONFIG_PATH} "@cmor_EXTERNALS@/lib/pkgconfig:/usr/lib/x86_64-linux-gnu/pkgconfig:/usr/lib64/pkgconfig:/usr/lib/pkgconfig:/usr/share/pkgconfig:$ENV{PKG_CONFIG_PATH}")
set(ENV{PKG_CONFIG} "@cmor_PKG_CONFIG_EXECUTABLE@")

if (BASH_CONFIGURE)
	set(CONFIGURE_SHELL "bash")
else()
	set(CONFIGURE_SHELL "sh")
endif()

if (CONF_PATH_XTRA)
  message("[INFO] configure is in subdirectory: ${CONF_PATH_XTRA}")
else()
  set(CONF_PATH_XTRA ".")
endif()
include(@cmor_CMAKE_BINARY_DIR@/cmor_common_environment.cmake)

message("CONFIGURE_ARGS IS ${CONFIGURE_ARGS}")
message("LD_ARGS IS $ENV{@LIBRARY_PATH@}")
message("CFLAGS : $ENV{CFLAGS}")

execute_process(
  COMMAND env CC=$ENV{CC} CFLAGS=$ENV{CFLAGS} LD_LIBRARY_PATH=$ENV{@LIBRARY_PATH@} DYLD_FALLBACK_LIBRARY_PATH=$ENV{@LIBRARY_PATH@} @LIBRARY_PATH@=$ENV{@LIBRARY_PATH@} PKG_CONFIG=$ENV{PKG_CONFIG} PKG_CONFIG_PATH=$ENV{PKG_CONFIG_PATH} ${CONFIGURE_SHELL} ${CONF_PATH_XTRA}/configure --prefix=${INSTALL_DIR} ${CONFIGURE_ARGS}
  WORKING_DIRECTORY "${WORKING_DIR}"
  RESULT_VARIABLE res)

if(NOT ${res} EQUAL 0)
  message("Config Errors detected: \n${CMOR_OUT}\n${CMOR_ERR}")
  message(FATAL_ERROR "Error in config")
endif()
message("Config succeeded.")
